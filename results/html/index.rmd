---
title: "Benchmarking Large Language Models (LLM) for Extracting Scores for Systematic Review: PRISMA-2009, AMSTAR, PRECIS-2"
author: "Tim Woelfle"
date: "2023-08-22"
output: 
  flexdashboard::flex_dashboard:
    source_code: ""
    mathjax: NULL
    self_contained: FALSE
    lib_dir: "lib/"
---

```{r}
suppressPackageStartupMessages(library(ggplot2))
suppressPackageStartupMessages(library(ggrepel))
suppressPackageStartupMessages(library(DT))

# Main experiments

consensus_vs = rbind(
  prisma_human_rater1 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_human_rater1/results/Human Consensus_Human Rater 1_27_domains_3_options_IRR.csv", row.names = 1),
prisma_human_rater2 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_human_rater2/results/Human Consensus_Human Rater 2_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_exp1_claude = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_claude2/results/Human Consensus_LLM_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_exp2_claude = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_claude2_rep/results/Human Consensus_LLM 2nd run_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_exp3_claude_gpt = read.csv("../PRISMA-AMSTAR/cullis2017_prisma_claude2/results/Human Consensus_LLM_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_exp4_gpt = read.csv("../PRISMA-AMSTAR/cullis2017_prisma_gpt3.5/results/Human Consensus_LLM_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_exp5_gpt = read.csv("../PRISMA-AMSTAR/cullis2017_prisma_gpt3.5_rep/results/Human Consensus_LLM 2nd run_27_domains_3_options_IRR.csv", row.names = 1),

  amstar_human_rater1 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_human_rater1/results/Human Consensus_Human Rater 1_11_domains_3_options_IRR.csv", row.names = 1),
amstar_human_rater2 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_human_rater2/results/Human Consensus_Human Rater 2_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_exp1_claude = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_claude2/results/Human Consensus_LLM_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_exp2_claude = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_claude2_rep/results/Human Consensus_LLM 2nd run_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_exp3_claude_gpt = read.csv("../PRISMA-AMSTAR/cullis2017_amstar_claude2/results/Human Consensus_LLM_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_exp4_gpt = read.csv("../PRISMA-AMSTAR/cullis2017_amstar_gpt3.5/results/Human Consensus_LLM_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_exp5_gpt = read.csv("../PRISMA-AMSTAR/cullis2017_amstar_gpt3.5_rep/results/Human Consensus_LLM 2nd run_11_domains_3_options_IRR.csv", row.names = 1),

  precis2_human_rater1 = read.csv("../PRECIS-2/pragms-pragqol-56_precis2_human_rater1/results/Human Consensus_Human Rater 1_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_human_rater2 = read.csv("../PRECIS-2/pragms-pragqol-56_precis2_human_rater2/results/Human Consensus_Human Rater 2_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_exp1_claude = read.csv("../PRECIS-2/pragms-pragqol-56_loudon2015-toolkit_claude2/results/Human Consensus_LLM_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_exp2_claude = read.csv("../PRECIS-2/pragms-pragqol-56_loudon2015-toolkit_claude2_rep/results/Human Consensus_LLM 2nd run_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_exp3_claude_gpt = read.csv("../PRECIS-2/pragms-pragqol-56_toolkit_claude2/results/Human Consensus_LLM_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_exp4_gpt = read.csv("../PRECIS-2/pragms-pragqol-56_toolkit_gpt3.5/results/Human Consensus_LLM_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_exp5_gpt = read.csv("../PRECIS-2/pragms-pragqol-56_toolkit_gpt3.5_rep/results/Human Consensus_LLM 2nd run_9_domains_4_options_IRR.csv", row.names = 1)
)

reproducibility = rbind(
  prisma_human_irr = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_human_rater2/results/Human Rater 1_Human Rater 2_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_human_irr_combined = list(NA, NA, NA),
  prisma_claude_irr = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_claude2_rep/results/LLM_LLM 2nd run_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_claude_irr_combined = list(NA, NA, NA),
  prisma_claude_gpt_irr_combined = list(NA, NA, NA),
  prisma_gpt_irr = read.csv("../PRISMA-AMSTAR/cullis2017_prisma_gpt3.5_rep/results/LLM_LLM 2nd run_27_domains_3_options_IRR.csv", row.names = 1),
  prisma_gpt_irr_combined = list(NA, NA, NA),
  
  amstar_human_irr = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_human_rater2/results/Human Rater 1_Human Rater 2_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_human_irr_combined = list(NA, NA, NA),
  amstar_claude_irr = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_claude2_rep/results/LLM_LLM 2nd run_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_claude_irr_combined = list(NA, NA, NA),
  amstar_claude_gpt_irr_combined = list(NA, NA, NA),
  amstar_gpt_irr = read.csv("../PRISMA-AMSTAR/cullis2017_amstar_gpt3.5_rep/results/LLM_LLM 2nd run_11_domains_3_options_IRR.csv", row.names = 1),
  amstar_gpt_irr_combined = list(NA, NA, NA),

  precis2_human_irr = read.csv("../PRECIS-2/pragms-pragqol-56_precis2_human_rater2/results/Human Rater 1_Human Rater 2_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_human_irr_combined = list(NA, NA, NA),
  precis2_claude_irr = read.csv("../PRECIS-2/pragms-pragqol-56_loudon2015-toolkit_claude2_rep/results/LLM_LLM 2nd run_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_claude_irr_combined = list(NA, NA, NA),
  precis2_claude_gpt_irr_combined = list(NA, NA, NA),
  precis2_gpt_irr = read.csv("../PRECIS-2/pragms-pragqol-56_toolkit_gpt3.5_rep/results/LLM_LLM 2nd run_9_domains_4_options_IRR.csv", row.names = 1),
  precis2_gpt_irr_combined = list(NA, NA, NA)
)

# Self consistency

prisma_sc_3_of_5 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_llm-self-consistency-3/results/Human Consensus_LLM self-consistency combined_27_domains_4_options_IRR.csv", row.names = 1)
prisma_sc_4_of_5 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_llm-self-consistency-4/results/Human Consensus_LLM self-consistency combined_27_domains_4_options_IRR.csv", row.names = 1)
prisma_sc_5_of_5 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_llm-self-consistency-5/results/Human Consensus_LLM self-consistency combined_27_domains_4_options_IRR.csv", row.names = 1)

amstar_sc_3_of_5 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_llm-self-consistency-3/results/Human Consensus_LLM self-consistency combined_11_domains_4_options_IRR.csv", row.names = 1)
amstar_sc_4_of_5 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_llm-self-consistency-4/results/Human Consensus_LLM self-consistency combined_11_domains_4_options_IRR.csv", row.names = 1)
amstar_sc_5_of_5 = read.csv("../PRISMA-AMSTAR/cullis2017_amstar-prisma_llm-self-consistency-5/results/Human Consensus_LLM self-consistency combined_11_domains_4_options_IRR.csv", row.names = 1)

precis2_sc_3_of_5 = read.csv("../PRECIS-2/pragms-pragqol-56_precis2_llm-self-consistency-3/results/Human Consensus_LLM self-consistency combined_9_domains_5_options_IRR.csv", row.names = 1)
precis2_sc_4_of_5 = read.csv("../PRECIS-2/pragms-pragqol-56_precis2_llm-self-consistency-4/results/Human Consensus_LLM self-consistency combined_9_domains_5_options_IRR.csv", row.names = 1)
precis2_sc_5_of_5 = read.csv("../PRECIS-2/pragms-pragqol-56_precis2_llm-self-consistency-5/results/Human Consensus_LLM self-consistency combined_9_domains_5_options_IRR.csv", row.names = 1)

self_consistency = rbind(
  data.frame(
    score = "PRISMA",
    self_consistency = rep(c("3/5 consistent", "4/5 consistent", "5/5 consistent"), each=2),
    deferring_fraction = rep(c(prisma_sc_3_of_5["combined", "deferring_fraction"], prisma_sc_4_of_5["combined", "deferring_fraction"], prisma_sc_5_of_5["combined", "deferring_fraction"]), each=2),
    metric = rep(c("cohen_kappa_w", "agreement"), 3),
    value = unlist(c(prisma_sc_3_of_5["combined", c("cohen_kappa_w", "agreement")], prisma_sc_4_of_5["combined", c("cohen_kappa_w", "agreement")], prisma_sc_5_of_5["combined", c("cohen_kappa_w", "agreement")]))
  ),
  data.frame(
    score = "AMSTAR",
    self_consistency = rep(c("3/5 consistent", "4/5 consistent", "5/5 consistent"), each=2),
    deferring_fraction = rep(c(amstar_sc_3_of_5["combined", "deferring_fraction"], amstar_sc_4_of_5["combined", "deferring_fraction"], amstar_sc_5_of_5["combined", "deferring_fraction"]), each=2),
    metric = rep(c("cohen_kappa_w", "agreement"), 3),
    value = unlist(c(amstar_sc_3_of_5["combined", c("cohen_kappa_w", "agreement")], amstar_sc_4_of_5["combined", c("cohen_kappa_w", "agreement")], amstar_sc_5_of_5["combined", c("cohen_kappa_w", "agreement")]))
  ),
  data.frame(
    score = "PRECIS-2",
    self_consistency = rep(c("3/5 consistent", "4/5 consistent", "5/5 consistent"), each=2),
    deferring_fraction = rep(c(precis2_sc_3_of_5["combined", "deferring_fraction"], precis2_sc_4_of_5["combined", "deferring_fraction"], precis2_sc_5_of_5["combined", "deferring_fraction"]), each=2),
    metric = rep(c("cohen_kappa_w", "agreement"), 3),
    value = unlist(c(precis2_sc_3_of_5["combined", c("cohen_kappa_w", "agreement")], precis2_sc_4_of_5["combined", c("cohen_kappa_w", "agreement")], precis2_sc_5_of_5["combined", c("cohen_kappa_w", "agreement")]))
  )
)
self_consistency$score = factor(self_consistency$score, c("PRISMA", "AMSTAR", "PRECIS-2"))
```

Column {data-width=50}
-------------------------------------

### <a onclick="$('#DataTables_Table_0').DataTable().search('main').draw()" style="cursor: pointer">Main experiments</a> / <a onclick="$('#DataTables_Table_0').DataTable().search('').draw()" style="cursor: pointer">All experiments</a>

```{r}
data = data.frame(
  Score = rep(c("PRISMA 2009", "AMSTAR", "PRECIS-2"), each=7),
  Rater = c("Human Rater", "Human Rater 2", "Claude-2", "Claude-2 repeated", "Claude-2 GPT prompt", "GPT-3.5", "GPT-3.5 repeated"),
  URL = c("cullis2017_amstar-prisma_human_rater1_compare_consensus_rater1.html", "cullis2017_amstar-prisma_human_rater2_compare_consensus_rater2.html", "cullis2017_amstar-prisma_claude2_compare_human_lmm.html", "cullis2017_amstar-prisma_claude2_rep_compare_human_lmm.html", "cullis2017_prisma_claude2_compare_human_lmm.html", "cullis2017_prisma_gpt3.5_compare_human_lmm.html", "cullis2017_prisma_gpt3.5_rep_compare_human_lmm.html", "cullis2017_amstar-prisma_human_rater1_compare_consensus_rater1.html", "cullis2017_amstar-prisma_human_rater2_compare_consensus_rater2.html", "cullis2017_amstar-prisma_claude2_compare_human_lmm.html", "cullis2017_amstar-prisma_claude2_rep_compare_human_lmm.html", "cullis2017_amstar-prisma_claude2_rep_cullis2017_amstar_claude2_compare_human_lmm.html", "cullis2017_amstar_gpt3.5_compare_human_lmm.html", "cullis2017_amstar_gpt3.5_rep_compare_human_lmm.html", "pragms-pragqol-56_precis2_human_rater1_compare_consensus_rater1.html", "pragms-pragqol-56_precis2_human_rater2_compare_consensus_rater2.html", "pragms-pragqol-56_loudon2015-toolkit_claude2_compare_human_lmm.html", "pragms-pragqol-56_loudon2015-toolkit_claude2_rep_compare_human_lmm.html", "pragms-pragqol-56_toolkit_claude2_compare_human_lmm.html", "pragms-pragqol-56_toolkit_gpt3.5_compare_human_lmm.html", "pragms-pragqol-56_toolkit_gpt3.5_rep_compare_human_lmm.html"),
  consensus_vs = consensus_vs[grepl("combined", rownames(consensus_vs)), 1:2],
  reproducibility = reproducibility[grepl("combined", rownames(reproducibility)), 1:2],
  main = c("main", "", "main", "", "", "main", "")
)

container = htmltools::withTags(table(
  class = 'display',
  thead(
    tr(
      th(rowspan = 2, 'Score', width=100),
      th(rowspan = 2, 'Rater', width=120),
      th(rowspan = 2),
      th(colspan = 2, 'Human Consensus'),
      th(colspan = 2, 'Reproducibility'),
      th(rowspan = 2),
    ),
    tr(
      th('Cohen κ'),
      th('agreement'),
      th('Cohen κ'),
      th('agreement')
    )
  )
))

cell_js = function(col_id) paste0("function(data, type, row, meta) { return '<a href=\"'+row[", col_id, "]+'\" target=\"_blank\" title=\"Open experiment details\">' + data + '</a>' }")

datatable(
  data, 
  container=container, 
  rownames = F, 
  options=list(
    bPaginate=F, dom="t",
    columnDefs=list(list(targets=1, render=JS(cell_js(2))), list(targets=c(2,7), visible=F)),
    search=list(search="main")
  )
) %>% formatRound(4:7, 2)
```

Column {data-width=50}
-------------------------------------

### RPISMA 2009: Claude-2: Score heatmaps

```{r, results='asis'}
cat(paste0('<img data-figure-id="fig1" src="../PRISMA-AMSTAR/cullis2017_amstar-prisma_claude2/results/Human Consensus_LLM_27_domains_3_options.png">'))
```

### Self consistency

```{r, fig.width=8, fig.height=4}
ggplot(self_consistency, aes(deferring_fraction, value, color=score)) + 
  geom_line(aes(linetype=metric)) + 
  geom_point(aes(shape=self_consistency)) + xlim(0,1) + ylim(0,1) +
  theme_bw() + xlab("Deferring fraction") + ylab("Metric")
```

```{r}
ggplot(data.frame(x=consensus_vs[grepl("prisma_human_rater1", rownames(consensus_vs)), "agreement"], y=prisma_sc_5_of_5[,"agreement"], text=rownames(prisma_sc_5_of_5)), aes(x,y)) + 
  geom_point() + 
  geom_text_repel(aes(label=text), hjust="middle", vjust=-0.8) + xlim(-0.1,1) + ylim(-0.1,1) + 
  geom_abline() + 
  theme_bw() + xlab("Human Consensus vs Human Rater 1") + ylab("Human Consensus vs LMM") + ggtitle("PRISMA agreement")
```

