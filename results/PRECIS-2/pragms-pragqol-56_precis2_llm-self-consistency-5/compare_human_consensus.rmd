---
title: "PRECIS-2 Scores in PragMeta: Human Consensus vs LLM - self-consistent for 5 / 5 experiments"
author: "Tim Woelfle"
date: "2023-08-15"
output: 
  flexdashboard::flex_dashboard:
    source_code: ""
    mathjax: NULL
    self_contained: FALSE
    lib_dir: "lib/"
---

```{css}
table {
  margin: auto;
  border-top: 1px solid #666;
  border-bottom: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }

pre {
  white-space: pre-wrap;
  word-break: keep-all;
}

/* Hack to make prompt-tab(s) scrollable again */
div.level3.tab-pane .chart-stage {
  overflow: scroll;
}
```

```{r}
source("../../../src/results_functions_precis2.r")
source("../../../src/results_functions.r")

x_rater = "Human Consensus"
y_rater = "LLM self-consistency combined"

human = read.csv2("../../../data/PRECIS-2/pragms-pragqol-56/human_consensus.csv", row.names = "trials.trials_id", na.strings = NULL)
human$author_year = paste0(human$trials.author, " (", human$trials.pub_year, ")")
human$title = human$trials.title
human$DOI = human$trials.doi

# Experiment 1: Claude
results_1 = read.csv("../pragms-pragqol-56_loudon2015-toolkit_claude2/results.csv", row.names = 1, na.strings = NULL)
results_1[domains] = t(sapply(strsplit(gsub("\\[|\\]|\\'", "", results_1$llm_scores), ", ", fixed=T), as.character))
# Experiment 2: Claude (rep)
results_2 = read.csv("../pragms-pragqol-56_loudon2015-toolkit_claude2_rep/results.csv", row.names = 1, na.strings = NULL)
results_2[domains] = t(sapply(strsplit(gsub("\\[|\\]|\\'", "", results_2$llm_scores), ", ", fixed=T), as.character))
# Experiment 3: GPT
results_3 = read.csv("../pragms-pragqol-56_toolkit_gpt3.5/results.csv", row.names = 1, na.strings = NULL)
results_3[domains] = t(sapply(strsplit(gsub("\\[|\\]|\\'", "", results_3$llm_scores), ", ", fixed=T), as.character))
# Experiment 4: GPT (rep)
results_4 = read.csv("../pragms-pragqol-56_toolkit_gpt3.5_rep/results.csv", row.names = 1, na.strings = NULL)
results_4[domains] = t(sapply(strsplit(gsub("\\[|\\]|\\'", "", results_4$llm_scores), ", ", fixed=T), as.character))
# Experiment 5: Claude (GPT-prompt)
results_5 = read.csv("../pragms-pragqol-56_toolkit_claude2/results.csv", row.names = 1, na.strings = NULL)
results_5[domains] = t(sapply(strsplit(gsub("\\[|\\]|\\'", "", results_5$llm_scores), ", ", fixed=T), as.character))

# Experiment 4 has the lowest number of rows (53)
results_1 = results_1[rownames(results_4),]
results_2 = results_2[rownames(results_4),]
results_3 = results_3[rownames(results_4),]
results_5 = results_5[rownames(results_4),]

stopifnot((rownames(results_1) == rownames(results_2)) & (rownames(results_1) == rownames(results_3)) & (rownames(results_1) == rownames(results_4)) & (rownames(results_1) == rownames(results_5)))
stopifnot((domains %in% colnames(results_1)) & (domains %in% colnames(results_2)) & (domains %in% colnames(results_3)) & (domains %in% colnames(results_4)) & (domains %in% colnames(results_5)))

results = data.frame()
# Combine results
for (row in rownames(results_1)) {
  self_consistency = sapply(domains, function(domain)table(c(results_1[row, domain], results_2[row, domain], results_3[row, domain], results_4[row, domain], results_5[row, domain])))
  self_consistency = sapply(self_consistency, function(table) names(which(table==5)))
  results[row, paste0(domains, "_", y_rater)] = ifelse(sapply(self_consistency, length), self_consistency, "deferred")
}
results$author_year = human[rownames(results), "author_year"]
results$title = human[rownames(results), "title"]
results$link = paste0("https://doi.org/", human[rownames(results), "DOI"])
results[paste0(domains, "_", x_rater)] = human[rownames(results), c("precis2.eligibility_score", "precis2.recruit_score", "precis2.set_score", "precis2.org_score", "precis2.flex_score", "precis2.adherence_score", "precis2.fu_score", "precis2.out_score", "precis2.analysis_score")]
#results[is.na(results)] = "NA"

results = results[order(as.integer(rownames(results))),]

# Add "deferred" option for self-consistency experiments
factorize = function(x) factor(x, levels=c("1","2","3","4","5","NA", "deferred"))
factorize_pooled = function(x) factor(x, levels=c("1","2","3","4","5","NA","deferred"), labels=c("1/2", "1/2", "3", "4/5", "4/5", "NA", "deferred"))
weight_matrix = matrix(c(0,1,4,9,16,4,0, 1,0,1,4,9,4,0, 4,1,0,1,4,4,0, 9,4,1,0,1,4,0, 16,9,4,1,0,4,0, 4,4,4,4,4,0,0, 0,0,0,0,0,0,0), nrow=7)
weight_matrix_pooled = matrix(c(0,1,4,1,0, 1,0,1,1,0, 4,1,0,1,0, 1,1,1,0,0, 0,0,0,0,0), nrow=5)
```

Column {data-width=55}
-------------------------------------

### Score comparisons of `r nrow(results)` publications

```{r}
datatable_scores(results, x_rater, y_rater)
```

```{r, results='hide'}
plot_precis2_pooled = plot_metrics_overview(results, domains, x_rater=x_rater, y_rater=y_rater, factorize_pooled, weight_matrix_pooled)
png_precis2_pooled = paste0("../PRECIS-2/", gsub(".*/", "", getwd()), "/results/human_consensus_9_domains_5_options.png")

plot_precis2 = plot_metrics_overview(results, domains, x_rater, y_rater, factorize, weight_matrix)
png_precis2 = paste0("../PRECIS-2/", gsub(".*/", "", getwd()), "/results/human_consensus_9_domains_7_options.png")
```

### Score heatmaps (<a onclick="$('p.image-container')[0].style = 'background: url(&quot;`r png_precis2_pooled`&quot;) center center / contain no-repeat;'; $('p.image-container img')[0].src = &quot;`r png_precis2_pooled`&quot;;" style="cursor: pointer">pooled</a> / <a onclick="$('p.image-container')[0].style = 'background: url(&quot;`r png_precis2`&quot;) center center / contain no-repeat;'; $('p.image-container img')[0].src = &quot;`r png_precis2`&quot;;" style="cursor: pointer">unpooled</a>) {data-height=720}

```{r, results='asis'}
cat(paste0('<img data-figure-id="fig1" src="', png_precis2_pooled, '" width="1536" onclick="window.open(this.src)" style="cursor: pointer">'))
```

Column {data-width=45}
-------------------------------------

### Individual results

```{r, results="asis"}
cat_individual_results(results, x_rater, y_rater, NULL, NULL, show_llm_message=F)
```
