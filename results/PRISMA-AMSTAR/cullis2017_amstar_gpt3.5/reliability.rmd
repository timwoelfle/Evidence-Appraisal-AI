---
title: "AMSTAR Scores in Cullis 2017: GPT 3.5 reproducibility"
author: "Tim Woelfle"
date: "2023-08-10"
output: 
  flexdashboard::flex_dashboard:
    source_code: ""
    mathjax: NULL
    self_contained: FALSE
    lib_dir: "lib/"
---

```{css}
table {
  margin: auto;
  border-top: 1px solid #666;
  border-bottom: 1px solid #666;
}
table thead th { border-bottom: 1px solid #ddd; }
th, td { padding: 5px; }

pre {
  white-space: pre-wrap;
  word-break: keep-all;
}

/* Hack to make prompt-tab scrollable again */
div.level3.tab-pane .chart-stage {
  overflow: scroll;
}
```

```{r}
source("../../../src/results_functions_prisma_amstar.r")
source("../../../src/results_functions.r")

x_rater = "LLM"
y_rater = "LLM 2nd run"
domains = amstar

human = read.csv2("../../../data/PRISMA-AMSTAR/cullis2017/S1Dataset_TW.csv", row.names = 1, na.strings = NULL)

results = read.csv("results.csv", row.names = 1)
results$author_year = human[rownames(results), "author_year"]
results$title = human[rownames(results), "title"]
results$link = paste0("https://doi.org/", human[rownames(results), "DOI"])
results[paste0(domains, "_", x_rater)] = t(sapply(strsplit(gsub("\\[|\\]|\\'", "", results$llm_scores), ", ", fixed=T), as.character)) # strtoi

results_2nd = read.csv("../cullis2017_amstar_gpt3.5_rep/results.csv", row.names = 1)
results_2nd[paste0(domains, "_", y_rater)] = t(sapply(strsplit(gsub("\\[|\\]|\\'", "", results_2nd$llm_scores), ", ", fixed=T), as.character)) # strtoi

# Combine results
results[paste0(domains, "_", y_rater)] = results_2nd[rownames(results), paste0(domains, "_", y_rater)]

results = results[order(as.integer(rownames(results))),]

quote_accuracy = read.csv("quote_accuracy.csv")

system_prompt = readChar("prompt_template/system.txt", file.info("prompt_template/system.txt")$size)
user_prompt = readChar("prompt_template/user.txt", file.info("prompt_template/user.txt")$size)
```

Column {data-width=55}
-------------------------------------

### Score comparisons of `r nrow(results)` publications

```{r}
datatable_scores(results, x_rater, y_rater, factorize, weight_matrix)
```

```{r, results='hide'}
plot_overview = plot_metrics_overview(results, domains, x_rater=x_rater, y_rater=y_rater, factorize, weight_matrix, nrow=4, filename_prefix="reliability")
png_overview = paste0("../PRISMA-AMSTAR/", gsub(".*/", "", getwd()), "/results/reliability_", length(domains), "_domains_", nrow(weight_matrix), "_options.png")
```

### Score heatmaps {data-height=720}

```{r, results='asis'}
cat(paste0('<img data-figure-id="fig1" src="', png_overview, '" width="1536">'))
```

Column {data-width=45 .tabset}
-------------------------------------

### Individual results

```{r, results="asis"}
quote_accuracy$html_span = quote_accuracy_html_span(quote_accuracy)

domain_instructions = strsplit(system_prompt, "\n")[[1]]
domain_instructions = domain_instructions[!duplicated(domain_instructions)]
names(domain_instructions) = sapply(domain_instructions, function(x) strsplit(x, " ")[[1]][1])

cat_individual_results(results, x_rater, y_rater, domain_instructions, quote_accuracy, show_llm_message = F)
```

### LLM prompt (both runs)

* Model: `gpt-3.5-turbo-16k-0613`
* Temperature: `0`
* Briefing derived from: [Cullis 2017](https://doi.org/10.1371/journal.pone.0175213) Supporting information: [S1 Dataset](https://doi.org/10.1371/journal.pone.0175213.s004)

#### System prompt

```{r, results="asis"}
cat("<pre>\n")
cat(system_prompt, "\n")
cat("</pre>\n")
```

#### User prompt

```{r, results="asis"}
cat("<pre>\n")
cat(user_prompt, "\n")
cat("</pre>\n")
```
